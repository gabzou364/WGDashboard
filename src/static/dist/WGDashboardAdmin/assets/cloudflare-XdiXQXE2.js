import{_ as p,c as l,a as s,d as y,e as c,n as u,b as v,w as S,h as k,F as b,i as g,t as o,z as N,g as h,D as C,f as i}from"./index-LfruuXpB.js";const x={name:"CloudflareView",setup(){return{dashboardStore:C()}},data(){return{endpointGroups:[],dnsLogs:[],loading:!0,syncing:!1,cloudflareConfigured:!1}},mounted(){this.checkCloudflareConfig(),this.loadEndpointGroups(),this.loadDNSLogs(),this.refreshInterval=setInterval(()=>{this.loadEndpointGroups(),this.loadDNSLogs()},3e4)},beforeUnmount(){this.refreshInterval&&clearInterval(this.refreshInterval)},methods:{checkCloudflareConfig(){this.cloudflareConfigured=this.dashboardStore.Configuration?.Cloudflare?.api_token?.length>0},async loadEndpointGroups(){this.loading=!0,await h("/api/getWireguardConfigurations",{},async n=>{if(n.status&&n.data){const t=n.data,m=[];for(const _ of t)await h(`/api/configs/${_.Name}/endpoint-group`,{},async a=>{if(a.status&&a.data){const r=a.data;await h(`/api/configs/${_.Name}/nodes`,{},f=>{f.status&&f.data&&(r.nodes=f.data)}),r.dns_records=[],r.dns_status="Synced",m.push(r)}});this.endpointGroups=m}this.loading=!1})},async loadDNSLogs(){await h("/api/audit-logs",{action:"dns_updated",limit:20},n=>{n.status&&n.data&&(this.dnsLogs=n.data)})},async syncSingleDNS(n){this.syncing=!0,this.dashboardStore.newMessage("Cloudflare",`Syncing DNS for ${n}...`,"info"),await N(`/api/configs/${n}/sync-dns`,{},t=>{const m=t.status?"success":"danger";this.dashboardStore.newMessage("Cloudflare",t.message,m),t.status&&(this.loadEndpointGroups(),this.loadDNSLogs())}),this.syncing=!1},async syncAllDNS(){this.syncing=!0,this.dashboardStore.newMessage("Cloudflare","Syncing all DNS records...","info");for(const n of this.endpointGroups)await this.syncSingleDNS(n.config_name);this.syncing=!1,this.dashboardStore.newMessage("Cloudflare","All DNS records synced","success")},getDNSStatusBadge(n){switch(n){case"Synced":return"bg-success";case"Updating":return"bg-info";case"Failed":return"bg-danger";default:return"bg-secondary"}},formatTimestamp(n){return n?new Date(n).toLocaleString():"N/A"},parseLogDetails(n){if(!n)return"N/A";try{return JSON.parse(n).message||n}catch{return n}}}},D={class:"mt-5"},w={class:"container-fluid"},L={class:"d-flex align-items-center justify-content-between mb-4"},A=["disabled"],G={key:0,class:"spinner-border spinner-border-sm ms-2"},I={key:0},T={key:1},M={key:0,class:"text-center py-5"},P={key:1,class:"alert alert-info"},B={key:2,class:"row g-3"},E={class:"card h-100"},V={class:"card-header d-flex align-items-center justify-content-between"},U={class:"mb-0"},j={class:"d-flex gap-2"},z=["onClick","disabled"],F={class:"card-body"},O={class:"row"},W={class:"col-md-6"},q={class:"mb-2"},H={class:"mb-2"},J={class:"mb-2"},R={class:"mb-2"},Z={class:"mb-2"},K={class:"small"},Q={class:"col-md-6"},X={key:0},Y={class:"d-flex align-items-center"},$={class:"text-muted"},ss={key:1,class:"text-muted"},ts={key:0,class:"mt-3"},es={class:"table-responsive"},ns={class:"table table-sm table-bordered"},ls={class:"badge bg-secondary"},os={class:"small"},is={class:"mt-3 p-3 bg-light rounded"},as={class:"form-check"},ds=["checked"],rs={class:"form-check"},cs=["checked"],us={class:"text-muted d-block mt-2"},ms={key:3,class:"card mt-4"},fs={class:"card-body"},bs={class:"table-responsive"},gs={class:"table table-sm table-hover"},hs={class:"badge bg-info"};function _s(n,t,m,_,a,r){const f=k("RouterLink");return i(),l("div",D,[s("div",w,[s("div",L,[t[3]||(t[3]=s("h3",{class:"text-body mb-0"},[s("i",{class:"bi bi-cloud-arrow-up me-2"}),c("Cloudflare DNS Management ")],-1)),s("button",{class:"btn btn-primary",onClick:t[0]||(t[0]=(...e)=>r.syncAllDNS&&r.syncAllDNS(...e)),disabled:a.syncing},[t[1]||(t[1]=s("i",{class:"bi bi-arrow-repeat me-2"},null,-1)),t[2]||(t[2]=c("Sync All DNS ",-1)),a.syncing?(i(),l("span",G)):y("",!0)],8,A)]),s("div",{class:u(["alert",a.cloudflareConfigured?"alert-success":"alert-warning"]),role:"alert"},[s("i",{class:u(["bi me-2",a.cloudflareConfigured?"bi-check-circle-fill":"bi-exclamation-triangle-fill"])},null,2),a.cloudflareConfigured?(i(),l("span",I," Cloudflare API is configured and ready ")):(i(),l("span",T,[t[5]||(t[5]=c(" Cloudflare API token not configured. Go to ",-1)),v(f,{to:"/settings"},{default:S(()=>[...t[4]||(t[4]=[c("Settings",-1)])]),_:1}),t[6]||(t[6]=c(" to configure. ",-1))]))],2),a.loading?(i(),l("div",M,[...t[7]||(t[7]=[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"Loading...")],-1)])])):a.endpointGroups.length===0?(i(),l("div",P,[...t[8]||(t[8]=[s("i",{class:"bi bi-info-circle me-2"},null,-1),c(" No cluster configurations with Cloudflare DNS setup yet. Configure endpoint groups for your multi-node configurations. ",-1)])])):(i(),l("div",B,[(i(!0),l(b,null,g(a.endpointGroups,e=>(i(),l("div",{key:e.config_name,class:"col-12"},[s("div",E,[s("div",V,[s("h5",U,[s("samp",null,o(e.config_name),1)]),s("div",j,[s("span",{class:u(["badge",r.getDNSStatusBadge(e.dns_status)])},o(e.dns_status||"Unknown"),3),s("button",{class:"btn btn-sm btn-outline-primary",onClick:d=>r.syncSingleDNS(e.config_name),disabled:a.syncing},[...t[9]||(t[9]=[s("i",{class:"bi bi-arrow-repeat me-1"},null,-1),c("Sync ",-1)])],8,z)])]),s("div",F,[s("div",O,[s("div",W,[t[15]||(t[15]=s("h6",{class:"text-muted mb-3"},"Configuration",-1)),s("div",q,[t[10]||(t[10]=s("small",{class:"text-muted"},"Domain:",-1)),s("div",null,[s("strong",null,o(e.domain),1)])]),s("div",H,[t[11]||(t[11]=s("small",{class:"text-muted"},"Port:",-1)),s("div",null,o(e.port),1)]),s("div",J,[t[12]||(t[12]=s("small",{class:"text-muted"},"DNS Record:",-1)),s("div",null,o(e.cloudflare_record_name),1)]),s("div",R,[t[13]||(t[13]=s("small",{class:"text-muted"},"TTL:",-1)),s("div",null,o(e.ttl)+" seconds",1)]),s("div",Z,[t[14]||(t[14]=s("small",{class:"text-muted"},"Zone ID:",-1)),s("div",null,[s("code",K,o(e.cloudflare_zone_id),1)])])]),s("div",Q,[t[17]||(t[17]=s("h6",{class:"text-muted mb-3"},"Active Nodes",-1)),e.nodes&&e.nodes.length>0?(i(),l("div",X,[(i(!0),l(b,null,g(e.nodes,d=>(i(),l("div",{key:d.id,class:"mb-2"},[s("div",Y,[s("span",{class:u(["badge me-2",d.is_healthy?"bg-success":"bg-warning"])},o(d.is_healthy?"Healthy":"Unhealthy"),3),s("span",null,o(d.name),1)]),s("small",$,o(d.endpoint||"No endpoint"),1)]))),128))])):(i(),l("div",ss,[...t[16]||(t[16]=[s("small",null,"No nodes assigned",-1)])]))])]),e.dns_records&&e.dns_records.length>0?(i(),l("div",ts,[t[19]||(t[19]=s("h6",{class:"text-muted mb-2"},"Current DNS Records",-1)),s("div",es,[s("table",ns,[t[18]||(t[18]=s("thead",null,[s("tr",null,[s("th",null,"Type"),s("th",null,"Name"),s("th",null,"Content"),s("th",null,"Status")])],-1)),s("tbody",null,[(i(!0),l(b,null,g(e.dns_records,d=>(i(),l("tr",{key:d.id},[s("td",null,[s("span",ls,o(d.type),1)]),s("td",null,[s("code",os,o(d.name),1)]),s("td",null,o(d.content),1),s("td",null,[s("span",{class:u(["badge",d.proxied?"bg-warning":"bg-success"])},o(d.proxied?"Proxied (Warning!)":"DNS Only"),3)])]))),128))])])])])):y("",!0),s("div",is,[t[22]||(t[22]=s("h6",{class:"mb-2"},"Auto-Migration Settings",-1)),s("div",as,[s("input",{class:"form-check-input",type:"checkbox",checked:e.auto_migrate,disabled:""},null,8,ds),t[20]||(t[20]=s("label",{class:"form-check-label"}," Automatic peer migration enabled ",-1))]),s("div",rs,[s("input",{class:"form-check-input",type:"checkbox",checked:e.publish_only_healthy,disabled:""},null,8,cs),t[21]||(t[21]=s("label",{class:"form-check-label"}," Publish only healthy nodes to DNS ",-1))]),s("small",us," Minimum nodes required: "+o(e.min_nodes),1)])])])]))),128))])),a.dnsLogs.length>0?(i(),l("div",ms,[t[24]||(t[24]=s("div",{class:"card-header"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-journal-text me-2"}),c("Recent DNS Sync Logs ")])],-1)),s("div",fs,[s("div",bs,[s("table",gs,[t[23]||(t[23]=s("thead",null,[s("tr",null,[s("th",null,"Timestamp"),s("th",null,"Action"),s("th",null,"Configuration"),s("th",null,"Details"),s("th",null,"Status")])],-1)),s("tbody",null,[(i(!0),l(b,null,g(a.dnsLogs,e=>(i(),l("tr",{key:e.id},[s("td",null,[s("small",null,o(r.formatTimestamp(e.timestamp)),1)]),s("td",null,[s("span",hs,o(e.action),1)]),s("td",null,[s("samp",null,o(e.entity_id),1)]),s("td",null,[s("small",null,o(r.parseLogDetails(e.details)),1)]),s("td",null,[s("i",{class:u(["bi",e.success?"bi-check-circle text-success":"bi-x-circle text-danger"])},null,2)])]))),128))])])])])])):y("",!0)])])}const ps=p(x,[["render",_s],["__scopeId","data-v-16781ed9"]]);export{ps as default};
